# webç”¨ä¾‹é›†åˆ

## ç¯å¢ƒå®‰è£…

```shell
npm i @langchain/core
```

> Nodeç¯å¢ƒå®‰è£… `npm i langchain`
> 
>
> âš ï¸ï¼šå¦‚æœåœ¨ web ç¯å¢ƒç›´æ¥å¼•ç”¨ `langchain`ï¼Œä¼šå‡ºç°æŠ¥é”™ï¼š
> ```shell
> Uncaught TypeError: import_browser_external_node_async_hooks.AsyncLocalStorage is not a constructor 
> ```

#### Chat Model æ ¼å¤–å®‰è£…

- `deepseek`ï¼š`@langchain/deepseek`
- `openai`ï¼š`@langchain/openai`
- `gemini`ï¼š`@langchain/google-genai`

## Chat åŸºç¡€å¯¹è¯

```typescript
import { HumanMessage } from '@langchain/core/messages'
import { ChatDeepSeek } from '@langchain/deepseek'

async function main() {
  // åˆå§‹åŒ–æ¨¡å‹
	const model = new ChatDeepSeek({
    apiKey: process.env.DEEPSEEK_API_KEY,
    model: 'deepseek-chat'
  })
  
  // invokeè°ƒç”¨
  const result = await model.invoke([
    new HumanMessage('ä½ å¥½')
  ])
  
  // AIMessage
  console.log(result)
}
```

## Chat åŸºç¡€æµå¼å¯¹è¯

```ts
import { HumanMessage } from '@langchain/core/messages'
import { ChatDeepSeek } from '@langchain/deepseek'

async function main() {
  const model = new ChatDeepSeek({
    apiKey: process.env.DEEPSEEK_API_KEY,
    model: 'deepseek-chat',
    streaming: true // ä½¿ç”¨æµå¼è¾“å‡º
  })

  const stream = await baseModel.stream([
    new HumanMessage('ä½ æ˜¯è°?')
  ])

  // æ±‡æ€»AIè¿”å›
  let content = ''
  for await (const chunk of stream) {
    let chunkText = ''
    
    // å°è¯•å¤šç§æ–¹å¼è·å–å†…å®¹
    if (typeof chunk.content === 'string') {
      chunkText = chunk.content
    } else if (Array.isArray(chunk.content)) {
      // å¤„ç†å¤šæ¨¡æ€å†…å®¹æ•°ç»„
      chunkText = chunk.content
        .map((item: any) => {
          if (typeof item === 'string') return item
          if (item && typeof item === 'object' && item.type === 'text' && item.text) {
            return item.text
          }
          return ''
        })
        .join('')
    } else if (chunk.content) {
      chunkText = String(chunk.content)
    }

    if (chunkText) {
      content += chunkText
    }
  }

  console.log(content)
}
main()
```

## ç»“æ„åŒ–è¾“å‡º

#### ä¸€ã€withStructuredOutput

```typescript
import { z } from 'zod'
import { HumanMessage } from '@langchain/core/messages'
import { ChatDeepSeek } from '@langchain/deepseek'

async function main() {

  // å®šä¹‰ç»“æ„
  const schema = z.object({
    name: z.string().describe('ä½ çš„åå­—'),
    age: z.number().describe('ä½ çš„å¹´é¾„'),
  })

  const baseModel = new ChatDeepSeek({
    apiKey: process.env.DEEPSEEK_API_KEY,
    model: 'deepseek-chat'
  })

  // ç»‘å®šç»“æ„
  const model = baseModel.withStructuredOutput(schema)

  const result = await model.invoke([
    new HumanMessage('ä½ æ˜¯è°?')
  ])

  // {name: 'AIåŠ©æ‰‹', age: 0}
  console.log(result)
}
main()
```

#### äºŒã€**StructuredOutputParser**

```typescript
import { z } from 'zod'
import { HumanMessage } from '@langchain/core/messages'
import { ChatDeepSeek } from '@langchain/deepseek'
import { StructuredOutputParser } from '@langchain/core/output_parsers'

async function main() {
	// å®šä¹‰ç»“æ„
  const schema = z.object({
    name: z.string().describe('ä½ çš„åå­—'),
    age: z.number().describe('ä½ çš„å¹´é¾„'),
  })
  
  // æ„å»º StructuredOutputParser
  const parser = StructuredOutputParser.fromZodSchema(schema)
  // è·å–è§„èŒƒè¾“å‡ºçš„æç¤ºè¯
  const formatInstructions = parser.getFormatInstructions()

  const model = new ChatDeepSeek({
    apiKey: process.env.DEEPSEEK_API_KEY,
    model: 'deepseek-chat'
  })

  // åœ¨æç¤ºè¯ä¸­åŠ å…¥è§„èŒƒè¾“å‡ºçš„æç¤ºè¯
  const result = await model.invoke([
    new HumanMessage(`ä½ æ˜¯è°?\n\nè¾“å‡ºè¦æ±‚ï¼š\n${formatInstructions}`)
  ])

  // ä½¿ç”¨ StructuredOutputParser è§£æ AI è¾“å‡ºå†…å®¹
  const output = await parser.parse(result.content as string)

  // {name: 'DeepSeek', age: 2}
  console.log(output)
}
```

## Agent

> âš ï¸ï¼šlangchain çš„ agent æ˜¯ä¸æ”¯æŒã€ä¸å»ºè®®åœ¨ web ç¯å¢ƒä½¿ç”¨ agent çš„
>
> å¦‚æœä¸€å®šè¦åœ¨ web ç¯å¢ƒä½¿ç”¨ï¼Œéœ€è¦ç»™æ‰“åŒ…å™¨æ³¨å…¥ `node:async_hooks`ã€`async_hooks` çš„ polyfills
>
> ```ts
> // async_hooks.ts
> 
> export class AsyncLocalStorage<T = unknown> {
>   private _store: T | undefined
> 
>   getStore(): T | undefined {
>     return this._store
>   }
> 
>   enterWith(store: T) {
>     this._store = store
>   }
> 
>   disable() {
>     this._store = undefined
>   }
> 
>   run<R>(store: T, callback: (...args: any[]) => R, ...args: any[]): R {
>     const prev = this._store
>     this._store = store
>     try {
>       return callback(...args)
>     } finally {
>       this._store = prev
>     }
>   }
> }
> ```
>
> ```ts
> // vite.config.ts
> 
> export default defineConfig({
>   resolve: {
>     alias: {
>       'node:async_hooks': path.resolve(__dirname, 'polyfills/async_hooks.ts'),
>       'async_hooks': path.resolve(__dirname, 'polyfills/async_hooks.ts'),
>     }
>   }
> })
> ```

#### æ™®é€šè¾“å‡º

```typescript
import { HumanMessage } from '@langchain/core/messages'
import { ChatDeepSeek } from '@langchain/deepseek'
import { createAgent } from 'langchain'

async function main() {

  const model = new ChatDeepSeek({
    apiKey: process.env.DEEPSEEK_API_KEY,
    model: 'deepseek-chat'
  })

  const agent = createAgent({
    model: model,
    tools: [],
  })

  const result = await agent.invoke({
    messages: [
      new HumanMessage('ä½ æ˜¯è°?')
    ]
  })

  // [HumanMessage, AIMessage]
  console.log(result)
}
```

#### å·¥å…·è°ƒç”¨

```typescript
import { z } from 'zod'
import { HumanMessage } from '@langchain/core/messages'
import { ChatDeepSeek } from '@langchain/deepseek'
import { DynamicStructuredTool } from '@langchain/core/tools'
import { createAgent } from 'langchain'

async function main() {

  const model = new ChatDeepSeek({
    apiKey: process.env.DEEPSEEK_API_KEY,
    model: 'deepseek-chat'
  })

  // åˆ›å»ºå·¥å…·
  const mockTool = new DynamicStructuredTool({
    name: 'weather',
    description: 'Get the weather of a city',
    func: async (city: string) => {
      return `The weather of ${city} is sunny`
    },
    schema: z.object({
      city: z.string().describe('The city to get the weather of')
    })
  })

  const agent = createAgent({
    model: model,
    tools: [mockTool], // æ³¨å…¥å·¥å…·
  })

  const result = await agent.invoke({
    messages: [
      new HumanMessage('ä»Šå¤©åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·?')
    ]
  })

  // [HumangMessage, AIMessage, ToolMessage, AIMessage]
  console.log(result)
}
main()
```

#### å·¥å…· + ç»“æ„åŒ–è¾“å‡º

> å®˜æ–¹è¯´å¦‚ä¸‹ä½¿ç”¨ï¼Œä½†æ˜¯äº²æµ‹ä¸å¤ªå¥½ç”¨ï¼Œæœ‰äº›æ¨¡å‹å¯èƒ½å…¥å‚çš„keyä¸å«è¿™ä¸ªï¼Œæœ‰çš„ä¼šå’Œtoolså†²çª
> ```typescript
> const agent = createAgent({
>     model: "gpt-5",
>     tools: [],
>     responseFormat: providerStrategy(schema)
> });
> ```

```typescript
import { z } from 'zod'
import { AIMessage, HumanMessage } from '@langchain/core/messages'
import { ChatDeepSeek } from '@langchain/deepseek'
import { DynamicStructuredTool } from '@langchain/core/tools'
import { createAgent } from 'langchain'
import { StructuredOutputParser } from '@langchain/core/output_parsers'

async function main() {

  const model = new ChatDeepSeek({
    apiKey: process.env.DEEPSEEK_API_KEY,
    model: 'deepseek-chat'
  })

  const mockTool = new DynamicStructuredTool({
    name: 'weather',
    description: 'Get the weather of a city',
    func: async (city: string) => {
      return `The weather of ${city} is sunny`
    },
    schema: z.object({
      city: z.string().describe('The city to get the weather of')
    })
  })

  // ä½¿ç”¨ StructuredOutputParser
  const schema = z.object({
    weather: z.string().describe('The weather of the city'),
    description: z.string().describe('The description of the weather')
  })
  const parser = StructuredOutputParser.fromZodSchema(schema)
  const formatInstructions = parser.getFormatInstructions()

  const agent = createAgent({
    model: model,
    tools: [mockTool],
  })

  const result = await agent.invoke({
    messages: [
      new HumanMessage(`ä»Šå¤©åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·?\n\nè¾“å‡ºè¦æ±‚ï¼š\n${formatInstructions}`)
    ]
  })

  const lastMessage = result.messages[result.messages.length - 1] as AIMessage
  const output = await parser.parse(lastMessage.content as string)

  // {weather: 'sunny', description: 'åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—'}
  console.log(output)
}
main()
```

#### è®°å¿†

```typescript
import { HumanMessage } from '@langchain/core/messages'
import { ChatDeepSeek } from '@langchain/deepseek'
import { createAgent } from 'langchain'
import { MemorySaver } from '@langchain/langgraph'

// åœ¨å†…å­˜ä¸­åˆ›å»ºè®°å¿†ç®¡ç†
const checkpointer = new MemorySaver()

async function main() {

  const model = new ChatDeepSeek({
    apiKey: process.env.DEEPSEEK_API_KEY,
    model: 'deepseek-chat',
  })

  const agent = createAgent({
    model: model,
    tools: [],
    checkpointer // è¿½åŠ è®°å¿†ç®¡ç†
  })

  await agent.invoke({
    messages: [
      new HumanMessage(`æˆ‘å«å°æ˜`)
    ],
    // è¯·æ±‚æ—¶å¸¦ä¸Š thread_id
  }, { configurable: { thread_id: "1" } })

  const result = await agent.invoke({
    messages: [
      new HumanMessage(`æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ`)
    ],
  }, { configurable: { thread_id: "1" } })

  // [HumanMessage, AIMessage, HumanMessage, AIMessage(ä½ åˆšåˆšå‘Šè¯‰æˆ‘ï¼Œä½ çš„åå­—æ˜¯**å°æ˜**ï¼ğŸ˜Š)]
  console.log(result)
}
main()
```

