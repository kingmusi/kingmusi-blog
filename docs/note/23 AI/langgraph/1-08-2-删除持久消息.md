# åˆ é™¤æŒä¹…æ¶ˆæ¯

## æè¿°

ä¸€èˆ¬åªä¼šå‘çŠ¶æ€æ·»åŠ æ¶ˆæ¯ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶ä¹Ÿå¯èƒ½æƒ³è¦åˆ é™¤æ¶ˆæ¯ï¼ˆç›´æ¥ä¿®æ”¹çŠ¶æ€æˆ–ä½œä¸ºå›¾çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚

- ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·è¯´â€œå¿˜è®°æ‰€æœ‰å¯¹è¯â€æ—¶ï¼Œä½ å¸Œæœ›åˆ é™¤æ‰€æœ‰å¯¹è¯å†å²è®°å½•ã€‚
- ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨åˆ é™¤æ¶ˆæ¯å®ç°åªä¿ç•™æœ€æ–°çš„næ¡æ¶ˆæ¯

ä½¿ç”¨ `MessageState` ä½œä¸ºçŠ¶æ€å›¾ï¼Œå…¶ä¸­çš„ `reducer` å¯ä»¥æ¥å— `RemoveMessage` ä¿®é¥°ç¬¦ï¼Œ`reducer` å¯ä»¥ä½¿ç”¨è¿™äº› `RemoveMessage` ä»é”®ä¸­åˆ é™¤å¯¹åº”çš„æ¶ˆæ¯

> æ³¨æ„ï¼šè®¸å¤šæ¨¡å‹å¯¹æ¶ˆæ¯åˆ—è¡¨æœ‰æŸäº›è§„åˆ™ã€‚ä¾‹å¦‚ï¼Œæœ‰äº›æ¨¡å‹æœŸæœ›å®ƒä»¬ä»¥ `user` æ¶ˆæ¯å¼€å¤´ï¼Œå¦ä¸€äº›æ¨¡å‹æœŸæœ›æ‰€æœ‰å¸¦æœ‰å·¥å…·è°ƒç”¨çš„æ¶ˆæ¯éƒ½åè·Ÿå·¥å…·æ¶ˆæ¯ã€‚**åˆ é™¤æ¶ˆæ¯æ—¶ï¼Œä½ å°†éœ€è¦ç¡®ä¿ä¸è¿åè¿™äº›è§„åˆ™ã€‚**

## ä½¿ç”¨

å°†ä¼ å…¥çš„ç¬¬ä¸€æ¡æ¶ˆæ¯åˆ é™¤

```python
from langchain_core.messages import RemoveMessage

graph.update_state(config, {"messages": RemoveMessage(id=messages[0].id)})
```

## ä¾‹å­â€”â€”åˆ é™¤æ‰€æœ‰æ¶ˆæ¯ï¼Œä¿ç•™æœ€åä¸€æ¡

```python
from langchain_core.messages import HumanMessage
from my_openai.deepseekv3 import get_deepseek_v3_client
from langgraph.graph import StateGraph, START, END, MessagesState
from langgraph.checkpoint.memory import MemorySaver
from langchain_core.messages import RemoveMessage

# æŒä¹…åŒ–
memory = MemorySaver()
config = {"configurable": {"thread_id": "1" } }

builder = StateGraph(MessagesState)

llm = get_deepseek_v3_client()

# åˆ é™¤æ‰€æœ‰æ¶ˆæ¯ï¼Œåªä¿ç•™æœ€åä¸€æ¡æ¶ˆæ¯
def delete_messages(state: MessagesState):
  messages = state["messages"]
  if len(messages) > 1:
    return {"messages": [RemoveMessage(id = m.id) for m in messages[:-1]]}

def chatbot(state: MessagesState):
  return {
    "messages": [llm.invoke(state["messages"])]
  }

builder.add_node("chatbot", chatbot)
builder.add_node(delete_messages)
builder.add_edge(START, "delete_messages")
# æ¯æ¬¡åˆ é™¤æ¶ˆæ¯åï¼Œå†è°ƒç”¨chatbot
builder.add_edge("delete_messages", "chatbot")
builder.add_edge("chatbot", END)

graph = builder.compile(checkpointer=memory)
```

è°ƒç”¨ï¼š

```python
user_input = HumanMessage(content="ä½ å¥½ï¼Œæˆ‘å«å°æ˜ï¼")
events = graph.stream(
  {"messages": [user_input]},
  config,
  stream_mode="values"
)
for event in events:
  event["messages"][-1].pretty_print()

user_input = HumanMessage(content="æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ")
events = graph.stream(
  {"messages": [user_input]},
  config,
  stream_mode="values"
)
for event in events:
  event["messages"][-1].pretty_print()
```

```
================================ Human Message =================================

ä½ å¥½ï¼Œæˆ‘å«å°æ˜ï¼
================================== Ai Message ==================================

ä½ å¥½ï¼Œå°æ˜ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï½ğŸ˜Š ä»Šå¤©æœ‰ä»€ä¹ˆæƒ³èŠçš„ï¼Œæˆ–è€…éœ€è¦å¸®å¿™çš„å—ï¼Ÿæ— è®ºæ˜¯å­¦ä¹ ã€ç”Ÿæ´»è¿˜æ˜¯å…´è¶£çˆ±å¥½ï¼Œæˆ‘éƒ½å¯ä»¥é™ªä½ èŠèŠå“¦ï¼        
================================ Human Message =================================

æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ
================================ Human Message =================================

æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ
================================== Ai Message ==================================

ä½ è¿˜æ²¡æœ‰å‘Šè¯‰æˆ‘ä½ çš„åå­—å‘¢ï¼ğŸ˜Š ä½ å¯ä»¥å‘Šè¯‰æˆ‘ä½ çš„åå­—ï¼Œæˆ‘ä¼šè®°ä½å¹¶ç”¨æ¥ç§°å‘¼ä½ ï½æˆ–è€…ï¼Œå¦‚æœä½ å¸Œæœ›æˆ‘å¸®ä½ èµ·ä¸ªåå­—ï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ä½ çš„å–œå¥½å“¦ï¼
```

